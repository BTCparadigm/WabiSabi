@startuml
collections Satoshis
participant Coordinator
participant Alice1
participant Alice2
participant Bob
database Mempool

title Scenario: A Participant Is Consolidating 2 Coins (Alice1, Alice2) Into 1 (Bob)\n

== Input Registration ==

Satoshis -> Coordinator ++ : GET coordinator-status
return RoundStatuses[]

Alice1 -> Coordinator ++: POST input-registration: RoundId, Input, RoundParamSig, ZeroCredReqs[]
note right of Coordinator
    IsRoundFound()
    IsInputRegistrationPhase()
    IsUnspent()
    IsConfirmed()
    IsMature()
    IsStandardScript()
    IsNotMalleable()
    CheckRoundParamSig()
    IsAllowedIfBlameRound()
    IsNotBanned()
    UpdateIfDuplicateInput()
    SetAliceDeadline()
end note
return AliceId, ZeroCreds[]
...

Alice1 -> Coordinator ++: POST connection-confirmation: RoundId, AliceId, PresentedCreds[], RealCredReqs[], BalanceProof, ZeroCredReqs[]
note right of Coordinator
    IsRoundFound()
    IsInputRegistrationOrConnectionConfirmationPhase()
    IsAliceFound()
    EnsureUniqueSerialNumber()
    CheckCredProofs()
    ResetAliceDeadline()
end note
return ZeroCreds[]

Alice2 -> Coordinator ++: POST input-registration: RoundId, Input, RoundParamSig, ZeroCredReqs[]
note right of Coordinator
    IsRoundFound()
    IsInputRegistrationPhase()
    IsUnspent()
    IsConfirmed()
    IsMature()
    IsStandardScript()
    IsNotMalleable()
    CheckRoundParamSig()
    IsAllowedIfBlameRound()
    IsNotBanned()
    UpdateIfDuplicateInput()
    SetAliceDeadline()
end note
return AliceId, ZeroCreds[]

== Connection Confirmation ==

Alice1 -> Coordinator ++: POST connection-confirmation: RoundId, AliceId, PresentedCreds[], RealCredReqs[], BalanceProof, ZeroCredReqs[]
note right of Coordinator
    IsRoundFound()
    IsInputRegistrationOrConnectionConfirmationPhase()
    IsAliceFound()
    EnsureUniqueSerialNumber()
    CheckCredProofs()
end note
return RealCreds[]

Alice2 -> Coordinator ++: POST connection-confirmation: RoundId, AliceId, PresentedCreds[], RealCredReqs[], BalanceProof, ZeroCredReqs[]
note right of Coordinator
    IsRoundFound()
    IsInputRegistrationOrConnectionConfirmationPhase()
    IsAliceFound()
    EnsureUniqueSerialNumber()
    CheckCredProofs()
end note
return RealCreds[]

== Output Registration ==

Bob -> Coordinator ++: POST output-registration: RoundId, Output, PresentedCreds[]
note right of Coordinator
    IsRoundFound()
    IsOutputRegistrationPhase()
    IsStandardScript()
    EnsureUniqueSerialNumber()
    CheckCredProofs()
end note
return UnsignedTransactionSecret

== Transaction Signing ==

Satoshis -> Coordinator ++ : coordinator-status
return RoundStatuses[]

Alice1 -> Coordinator ++: POST transaction-signatures: RoundId, AliceId, InputSigs
note right of Coordinator
    IsRoundFound()
    IsTransactionSigningPhase()
    IsAliceFound()
    CheckInputSig()
    UpdateIfAlreadySigned()
end note
return ACK

Alice2 -> Coordinator ++: POST transaction-signatures: RoundId, AliceId, InputSigs
note right of Coordinator
    IsRoundFound()
    IsTransactionSigningPhase()
    IsAliceFound()
    CheckInputSig()
    UpdateIfAlreadySigned()
end note
return ACK

== Transaction Broadcasting ==

Coordinator -> Mempool**  : SignedTransaction

Satoshis -> Coordinator ++ : coordinator-status
return RoundStatuses[]

@enduml
